generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             Int              @id @default(autoincrement())
  email          String           @unique
  passwordHash   String           @map("password_hash")
  name           String
  role           UserRole         @default(sales)
  
  // Granular permission system
  permissions        Json     @default("{}") // Feature flags (UserPermissions interface)
  permissionPreset   String   @default("sales_basic") @map("permission_preset") // sales_basic, sales_advanced, master_lite, master_full, custom
  
  territoryId    Int?             @map("territory_id")
  isActive       Boolean          @default(true) @map("is_active")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  lastLogin      DateTime?        @map("last_login")
  clientNotes    ClientNote[]
  leadHistory    LeadHistory[]
  assignedLeads  Lead[]           @relation("AssignedTo")
  notes          Note[]
  repPerformance RepPerformance[]
  stageMetrics   StageMetrics[]
  territory      Territory?       @relation(fields: [territoryId], references: [id])
  workOrders     WorkOrder[]
  
  // Commission system relations
  compensationConfig    UserCompensationConfig?
  compensationOverrides ClientCompensationOverride[]
  paymentTransactions   PaymentTransaction[]
  salesRepClients       ClientProfile[] @relation("SalesRep")
  masterClients         ClientProfile[] @relation("MasterManager")
  
  // Bug reporting relations
  reportedBugs          BugReport[] @relation("BugReporter")
  assignedBugs          BugReport[] @relation("BugAssignee")
  resolvedBugs          BugReport[] @relation("BugResolver")
  
  // Settings relations
  settingsUpdates       GlobalSettings[] @relation("SettingsUpdater")

  @@index([territoryId])
  @@map("users")
}

model Territory {
  id           Int            @id @default(autoincrement())
  name         String
  cities       String[]
  zipCodes     String[]       @map("zip_codes")
  states       String[]
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  leads        Lead[]
  stageMetrics StageMetrics[]
  users        User[]

  @@map("territories")
}

model LeadSource {
  id          Int      @id @default(autoincrement())
  name        String
  type        String?
  costPerLead Decimal? @map("cost_per_lead") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  leads       Lead[]

  @@map("lead_sources")
}

model Lead {
  id                Int               @id @default(autoincrement())
  businessName      String            @map("business_name")
  website           String?
  phone             String
  email             String?
  address           String?
  city              String
  state             String
  zipCode           String            @map("zip_code")
  territoryId       Int?              @map("territory_id")
  assignedTo        Int?              @map("assigned_to")
  leadSourceId      Int?              @map("lead_source_id")
  status            LeadStatus        @default(available)
  statusChangedAt   DateTime          @default(now()) @map("status_changed_at")
  domainRating      Int?              @map("domain_rating")
  currentRank       Int?              @map("current_rank")
  reviewCount       Int?              @map("review_count")
  reviewAvg         Decimal?          @map("review_avg") @db.Decimal(3, 2)
  intelLastUpdated  DateTime?         @map("intel_last_updated")
  intelNeedsRefresh Boolean           @default(false) @map("intel_needs_refresh")
  dealValueTotal    Decimal           @default(0) @map("deal_value_total") @db.Decimal(10, 2)
  dealValueOneTime  Decimal           @default(0) @map("deal_value_one_time") @db.Decimal(10, 2)
  dealValueMonthly  Decimal           @default(0) @map("deal_value_monthly") @db.Decimal(10, 2)
  dealValueAnnual   Decimal           @default(0) @map("deal_value_annual") @db.Decimal(10, 2)
  mrr               Decimal           @default(0) @db.Decimal(10, 2)
  arr               Decimal           @default(0) @db.Decimal(10, 2)
  ltvEstimated      Decimal           @default(0) @map("ltv_estimated") @db.Decimal(10, 2)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  closeScore        Int?              @map("close_score")
  distanceFromMetro Decimal?          @map("distance_from_metro") @db.Decimal(6, 1)
  impactScore       Int?              @map("impact_score")
  marketType        String?           @map("market_type")
  pitchAngle        String?           @map("pitch_angle")
  priorityTier      String?           @map("priority_tier")
  suppressionSignal String?           @map("suppression_signal")
  wealthScore       String?           @map("wealth_score")
  clientProfile     ClientProfile?
  competitiveIntel  CompetitiveIntel?
  dealProducts      DealProduct[]
  leadHistory       LeadHistory[]
  assignedUser      User?             @relation("AssignedTo", fields: [assignedTo], references: [id])
  leadSource        LeadSource?       @relation(fields: [leadSourceId], references: [id])
  territory         Territory?        @relation(fields: [territoryId], references: [id])
  notes             Note[]
  workOrders        WorkOrder[]

  @@index([territoryId])
  @@index([assignedTo])
  @@index([status])
  @@index([city, zipCode])
  @@index([leadSourceId])
  @@index([phone])
  @@index([territoryId, status])
  @@index([assignedTo, status])
  @@map("leads")
}

model Note {
  id        Int      @id @default(autoincrement())
  leadId    Int      @map("lead_id")
  userId    Int      @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("notes")
}

model LeadHistory {
  id                  Int         @id @default(autoincrement())
  leadId              Int         @map("lead_id")
  userId              Int?        @map("user_id")
  oldStatus           LeadStatus? @map("old_status")
  newStatus           LeadStatus  @map("new_status")
  timeInPreviousStage Int?        @map("time_in_previous_stage")
  notes               String?
  changedAt           DateTime    @default(now()) @map("changed_at")
  lead                Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user                User?       @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([changedAt(sort: Desc)])
  @@map("lead_history")
}

model CompetitiveIntel {
  id                   Int      @id @default(autoincrement())
  leadId               Int      @unique @map("lead_id")
  domainRating         Int?     @map("domain_rating")
  currentRank          Int?     @map("current_rank")
  backlinks            Int?
  reviewCount          Int?     @map("review_count")
  reviewAvg            Decimal? @map("review_avg") @db.Decimal(3, 2)
  siteSpeedMobile      Int?     @map("site_speed_mobile")
  siteSpeedDesktop     Int?     @map("site_speed_desktop")
  competitors          Json?
  drGap                Int?     @map("dr_gap")
  backlinkGap          Int?     @map("backlink_gap")
  reviewGap            Int?     @map("review_gap")
  speedGapMobile       Int?     @map("speed_gap_mobile")
  speedGapDesktop      Int?     @map("speed_gap_desktop")
  keywordGaps          Json?    @map("keyword_gaps")
  recommendedPackage   String?  @map("recommended_package")
  estimatedTimeToRank1 Int?     @map("estimated_time_to_rank_1")
  fetchedAt            DateTime @default(now()) @map("fetched_at")
  apiCosts             Decimal  @default(0.03) @map("api_costs") @db.Decimal(10, 4)
  lead                 Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([fetchedAt(sort: Desc)])
  @@map("competitive_intel")
}

model Product {
  id                  Int                  @id @default(autoincrement())
  name                String
  description         String?
  sku                 String               @unique
  category            String?
  price               Decimal              @db.Decimal(10, 2)
  pricingModel        PricingModel         @map("pricing_model")
  isActive            Boolean              @default(true) @map("is_active")
  displayOrder        Int                  @default(0) @map("display_order")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  dealProducts        DealProduct[]
  upsellOpportunities UpsellOpportunity[]

  @@index([isActive])
  @@index([category])
  @@map("products")
}

model DealProduct {
  id              Int      @id @default(autoincrement())
  leadId          Int      @map("lead_id")
  productId       Int      @map("product_id")
  quantity        Int      @default(1)
  priceAtSale     Decimal  @map("price_at_sale") @db.Decimal(10, 2)
  discountPercent Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  finalPrice      Decimal  @map("final_price") @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])

  @@index([leadId])
  @@index([productId])
  @@map("deal_products")
}

model WorkOrder {
  id                    Int       @id @default(autoincrement())
  leadId                Int       @map("lead_id")
  userId                Int?      @map("user_id")
  executiveSummary      String?   @map("executive_summary")
  phasedRecommendations Json?     @map("phased_recommendations")
  pricingBreakdown      Json?     @map("pricing_breakdown")
  pdfUrl                String?   @map("pdf_url")
  fileSize              Int?      @map("file_size")
  sentViaEmail          Boolean   @default(false) @map("sent_via_email")
  emailSentAt           DateTime? @map("email_sent_at")
  viewedAt              DateTime? @map("viewed_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  lead                  Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user                  User?     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([sentViaEmail])
  @@map("work_orders")
}

model StageMetrics {
  id             Int        @id @default(autoincrement())
  stage          String
  territoryId    Int?       @map("territory_id")
  userId         Int?       @map("user_id")
  date           DateTime   @db.Date
  leadsCount     Int        @default(0) @map("leads_count")
  leadsEntered   Int        @default(0) @map("leads_entered")
  leadsExited    Int        @default(0) @map("leads_exited")
  conversionRate Decimal?   @map("conversion_rate") @db.Decimal(5, 2)
  avgTimeInStage Int?       @map("avg_time_in_stage")
  calculatedAt   DateTime   @default(now()) @map("calculated_at")
  territory      Territory? @relation(fields: [territoryId], references: [id], onDelete: Cascade)
  user           User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date(sort: Desc)])
  @@index([stage])
  @@index([territoryId])
  @@index([userId])
  @@map("stage_metrics")
}

model RepPerformance {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  date            DateTime @db.Date
  period          String
  leadsAssigned   Int      @default(0) @map("leads_assigned")
  leadsContacted  Int      @default(0) @map("leads_contacted")
  leadsWon        Int      @default(0) @map("leads_won")
  leadsLost       Int      @default(0) @map("leads_lost")
  conversionRate  Decimal? @map("conversion_rate") @db.Decimal(5, 2)
  totalRevenue    Decimal  @default(0) @map("total_revenue") @db.Decimal(10, 2)
  mrrAdded        Decimal  @default(0) @map("mrr_added") @db.Decimal(10, 2)
  arrAdded        Decimal  @default(0) @map("arr_added") @db.Decimal(10, 2)
  ltvAdded        Decimal  @default(0) @map("ltv_added") @db.Decimal(10, 2)
  avgDealSize     Decimal? @map("avg_deal_size") @db.Decimal(10, 2)
  notesAdded      Int      @default(0) @map("notes_added")
  workOrdersSent  Int      @default(0) @map("work_orders_sent")
  avgResponseTime Int?     @map("avg_response_time")
  calculatedAt    DateTime @default(now()) @map("calculated_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, period])
  @@index([userId])
  @@index([date(sort: Desc)])
  @@index([period])
  @@map("rep_performance")
}

model ClientProfile {
  id             Int                @id @default(autoincrement())
  leadId         Int                @unique @map("lead_id")
  businessName   String             @map("business_name")
  retainerAmount      Decimal              @default(2400) @map("retainer_amount") @db.Decimal(10, 2)
  healthScore         Int                  @default(50) @map("health_score")
  scanFrequency       String               @default("biweekly") @map("scan_frequency")
  voiceProfileId      String?              @map("voice_profile_id")
  status              String               @default("active")
  onboardedAt         DateTime             @default(now()) @map("onboarded_at")
  lastScanAt          DateTime?            @map("last_scan_at")
  nextScanAt          DateTime?            @map("next_scan_at")
  
  // Commission system fields
  salesRepId      Int?     @map("sales_rep_id")
  masterManagerId Int?     @map("master_manager_id")
  onboardedMonth  DateTime? @map("onboarded_month") @db.Date
  
  competitors         ClientCompetitor[]
  domains             ClientDomain[]
  notes               ClientNote[]
  lead                Lead                 @relation(fields: [leadId], references: [id])
  reports             ClientReport[]
  tasks               ClientTask[]
  scans               CompetitiveScan[]
  upsellOpportunities UpsellOpportunity[]
  content             ClientContent[]
  voiceProfile        VoiceProfile?
  
  // Commission system relations
  salesRep             User?    @relation("SalesRep", fields: [salesRepId], references: [id])
  masterManager        User?    @relation("MasterManager", fields: [masterManagerId], references: [id])
  compensationOverrides ClientCompensationOverride[]
  paymentTransactions   PaymentTransaction[]

  @@map("client_profiles")
}

model ClientCompetitor {
  id            Int           @id @default(autoincrement())
  clientId      Int           @map("client_id")
  businessName  String        @map("business_name")
  domain        String?
  googlePlaceId String?       @map("google_place_id")
  isActive      Boolean       @default(true) @map("is_active")
  addedAt       DateTime      @default(now()) @map("added_at")
  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_competitors")
}

model ClientDomain {
  id              Int           @id @default(autoincrement())
  clientId        Int           @map("client_id")
  domain          String
  type            String
  hosting         String
  wpUrl           String?       @map("wp_url")
  wpUsername      String?       @map("wp_username")
  wpAppPassword   String?       @map("wp_app_password")
  vercelProjectId String?       @map("vercel_project_id")
  githubRepo      String?       @map("github_repo")
  templateUsed    String?       @map("template_used")
  ownershipType   String        @default("ghm") @map("ownership_type")
  dnsVerified     Boolean       @default(false) @map("dns_verified")
  sslActive       Boolean       @default(false) @map("ssl_active")
  contentCount    Int           @default(0) @map("content_count")
  lastDeployedAt  DateTime?     @map("last_deployed_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_domains")
}

model ClientTask {
  id              Int           @id @default(autoincrement())
  clientId        Int           @map("client_id")
  title           String
  description     String?
  category        String
  priority        String        @default("P3")
  status          String        @default("queued")
  source          String        @default("manual")
  assignedTo      String?       @map("assigned_to")
  targetKeywords  Json?         @map("target_keywords")
  competitorRef   String?       @map("competitor_ref")
  contentBrief    Json?         @map("content_brief")
  draftContent    String?       @map("draft_content")
  approvedContent String?       @map("approved_content")
  deployedUrl     String?       @map("deployed_url")
  outcomeMetrics  Json?         @map("outcome_metrics")
  dueDate         DateTime?     @map("due_date")
  scanId          Int?          @map("scan_id")
  domainId        Int?          @map("domain_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deployedAt      DateTime?     @map("deployed_at")
  measuredAt      DateTime?     @map("measured_at")
  notes           ClientNote[]
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, status])
  @@index([clientId, category])
  @@index([clientId, priority])
  @@map("client_tasks")
}

model ClientNote {
  id        Int           @id @default(autoincrement())
  clientId  Int           @map("client_id")
  taskId    Int?          @map("task_id")
  authorId  Int           @map("author_id")
  type      String
  content   String
  isPinned  Boolean       @default(false) @map("is_pinned")
  tags      Json?
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  author    User          @relation(fields: [authorId], references: [id])
  client    ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  task      ClientTask?   @relation(fields: [taskId], references: [id])

  @@index([clientId, type])
  @@index([clientId, isPinned])
  @@index([taskId])
  @@map("client_notes")
}

model CompetitiveScan {
  id                  Int                  @id @default(autoincrement())
  clientId            Int                  @map("client_id")
  scanDate            DateTime             @default(now()) @map("scan_date")
  clientData          Json                 @map("client_data")
  competitors         Json
  deltas              Json
  alerts              Json
  healthScore         Int                  @map("health_score")
  apiCosts            Json?                @map("api_costs")
  status              String               @default("complete")
  client              ClientProfile        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  upsellOpportunities UpsellOpportunity[]

  @@index([clientId, scanDate(sort: Desc)])
  @@map("competitive_scans")
}

model ClientReport {
  id           Int           @id @default(autoincrement())
  clientId     Int           @map("client_id")
  type         String
  periodStart  DateTime      @map("period_start")
  periodEnd    DateTime      @map("period_end")
  content      Json
  pdfUrl       String?       @map("pdf_url")
  sentToClient Boolean       @default(false) @map("sent_to_client")
  createdAt    DateTime      @default(now()) @map("created_at")
  client       ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, type])
  @@map("client_reports")
}

model DiscoveryRun {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  vertical     String
  locations    Json
  filters      Json
  resultsCount Int      @map("results_count")
  pushedCount  Int      @default(0) @map("pushed_count")
  resultsCache Json?    @map("results_cache")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("discovery_runs")
}

model LocationPreset {
  id        Int      @id @default(autoincrement())
  name      String
  locations Json
  createdAt DateTime @default(now()) @map("created_at")

  @@map("location_presets")
}

model UpsellOpportunity {
  id              Int           @id @default(autoincrement())
  clientId        Int           @map("client_id")
  productId       Int           @map("product_id")
  scanId          Int?          @map("scan_id")
  status          String        @default("detected")
  opportunityScore Int          @map("opportunity_score")
  gapCategory     String        @map("gap_category")
  reasoning       String
  projectedMrr    Decimal       @map("projected_mrr") @db.Decimal(10, 2)
  projectedRoi    Decimal?      @map("projected_roi") @db.Decimal(5, 2)
  presentedAt     DateTime?     @map("presented_at")
  respondedAt     DateTime?     @map("responded_at")
  response        String?
  detectedAt      DateTime      @default(now()) @map("detected_at")
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])
  scan            CompetitiveScan? @relation(fields: [scanId], references: [id])

  @@index([clientId, status])
  @@index([status])
  @@index([opportunityScore(sort: Desc)])
  @@map("upsell_opportunities")
}

// ============================================================================
// COMMISSION SYSTEM TABLES
// ============================================================================

model UserCompensationConfig {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique @map("user_id")
  
  // Commission settings
  commissionEnabled  Boolean  @default(true) @map("commission_enabled")
  commissionAmount   Decimal  @default(1000) @map("commission_amount") @db.Decimal(10, 2)
  
  // Residual settings
  residualEnabled    Boolean  @default(true) @map("residual_enabled")
  residualAmount     Decimal  @default(200) @map("residual_amount") @db.Decimal(10, 2)
  residualStartMonth Int      @default(2) @map("residual_start_month")
  
  // Master manager settings (for masters only)
  masterFeeEnabled   Boolean  @default(false) @map("master_fee_enabled")
  masterFeeAmount    Decimal  @default(240) @map("master_fee_amount") @db.Decimal(10, 2)
  
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_compensation_config")
}

model ClientCompensationOverride {
  id                Int      @id @default(autoincrement())
  clientId          Int      @map("client_id")
  userId            Int      @map("user_id")
  
  // Override settings (null = use user default)
  commissionAmount  Decimal? @map("commission_amount") @db.Decimal(10, 2)
  residualAmount    Decimal? @map("residual_amount") @db.Decimal(10, 2)
  feeAmount         Decimal? @map("fee_amount") @db.Decimal(10, 2)
  
  reason            String?  // Why this client is different
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  client            ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([clientId, userId])
  @@map("client_compensation_overrides")
}

model PaymentTransaction {
  id              Int      @id @default(autoincrement())
  clientId        Int      @map("client_id")
  userId          Int      @map("user_id")
  
  type            String   // "commission" | "residual" | "master_fee"
  amount          Decimal  @db.Decimal(10, 2)
  month           DateTime @db.Date
  
  status          String   @default("pending") // "pending" | "paid" | "held" | "cancelled"
  paidAt          DateTime? @map("paid_at")
  notes           String?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, month])
  @@index([clientId, month])
  @@index([status])
  @@map("payment_transactions")
}

enum UserRole {
  master
  sales
}

enum LeadStatus {
  available
  scheduled
  contacted
  follow_up
  paperwork
  won
  lost_rejection
  lost_deferred
}

enum PricingModel {
  one_time
  monthly
  annual
}

// ============================================================================
// CONTENT GENERATION SYSTEM
// ============================================================================

model ClientContent {
  id           Int            @id @default(autoincrement())
  clientId     Int            @map("client_id")
  contentType  String         @map("content_type") // "blog", "social", "meta"
  title        String?
  content      String         @db.Text
  keywords     String[]
  status       String         @default("draft") // "draft", "review", "approved", "published", "scheduled"
  scheduledFor DateTime?      @map("scheduled_for")
  publishedAt  DateTime?      @map("published_at")
  metadata     Json?          // Store AI generation parameters, platform-specific data
  currentVersion Int         @default(1) @map("current_version")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  
  client       ClientProfile  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  versions     ContentVersion[]
  
  @@index([clientId, status])
  @@index([clientId, contentType])
  @@index([scheduledFor])
  @@map("client_content")
}

// ============================================================================
// VOICE PROFILE SYSTEM (SCRVNR)
// ============================================================================

model VoiceProfile {
  id                String   @id // voice_xxxxx_yyyyy format
  clientId          Int      @unique @map("client_id")
  tonality          String   @db.Text
  vocabulary        String[] // Array of key terms
  sentenceStructure String   @db.Text
  formality         Int      // 1-10 scale
  enthusiasm        Int      // 1-10 scale
  technicality      Int      // 1-10 scale
  brevity           Int      // 1-10 scale
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  client            ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("voice_profiles")
}

// ============================================================================
// CONTENT VERSIONING SYSTEM
// ============================================================================

model ContentVersion {
  id              Int      @id @default(autoincrement())
  contentId       Int      @map("content_id")
  versionNumber   Int      @map("version_number")
  title           String?
  content         String   @db.Text
  keywords        String[]
  metadata        Json?    // Store generation parameters
  changeNote      String?  @map("change_note") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       Int      @map("created_by")
  
  clientContent   ClientContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@index([contentId, versionNumber])
  @@map("content_versions")
}

// ============================================================================
// BUG REPORTING SYSTEM
// ============================================================================

model BugReport {
  id                Int      @id @default(autoincrement())
  
  // Reporter info
  userId            Int?     @map("user_id")
  userEmail         String?  @map("user_email")
  userName          String?  @map("user_name")
  
  // Bug details
  title             String
  description       String   @db.Text
  category          String   // "content", "compensation", "scans", "clients", "leads", "ui", "performance", "other"
  severity          String   @default("medium") // "low", "medium", "high", "critical"
  status            String   @default("new") // "new", "acknowledged", "in-progress", "resolved", "wont-fix"
  
  // Auto-captured metadata
  pageUrl           String   @map("page_url")
  userAgent         String   @map("user_agent")
  screenResolution  String   @map("screen_resolution")
  timestamp         DateTime @default(now())
  
  // Technical context
  browserInfo       Json?    @map("browser_info")  // Browser name, version, OS
  consoleErrors     Json?    @map("console_errors") // Last 10 console errors
  networkErrors     Json?    @map("network_errors") // Failed requests
  recentActions     Json?    @map("recent_actions") // User's last 5 actions
  sessionData       Json?    @map("session_data")   // Relevant session state
  
  // Assignment
  assignedTo        Int?     @map("assigned_to")    // Always David Kirsch initially
  priority          String   @default("high")       // "low", "medium", "high", "top"
  
  // Resolution
  resolvedAt        DateTime? @map("resolved_at")
  resolvedBy        Int?      @map("resolved_by")
  resolutionNotes   String?   @map("resolution_notes") @db.Text
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  user              User?     @relation("BugReporter", fields: [userId], references: [id])
  assignee          User?     @relation("BugAssignee", fields: [assignedTo], references: [id])
  resolver          User?     @relation("BugResolver", fields: [resolvedBy], references: [id])
  
  @@index([status, priority])
  @@index([category])
  @@index([assignedTo])
  @@index([createdAt(sort: Desc)])
  @@map("bug_reports")
}

// ============================================================================
// GLOBAL SETTINGS
// ============================================================================

model GlobalSettings {
  id                    Int      @id @default(autoincrement())
  
  // Commission Defaults
  defaultCommission     Float    @default(0.15) @map("default_commission")       // 15%
  defaultResidual       Float    @default(0.05) @map("default_residual")         // 5%
  masterManagerFee      Float    @default(240) @map("master_manager_fee")        // $240/mo
  
  // Feature Toggles
  contentStudioEnabled  Boolean  @default(true) @map("content_studio_enabled")
  scanningEnabled       Boolean  @default(true) @map("scanning_enabled")
  voiceCaptureEnabled   Boolean  @default(true) @map("voice_capture_enabled")
  bugReportingEnabled   Boolean  @default(true) @map("bug_reporting_enabled")
  
  // Scan Settings
  scanFrequencyDays     Int      @default(30) @map("scan_frequency_days")
  scanCostLimit         Float    @default(100) @map("scan_cost_limit")          // $100/mo
  
  // Notification Settings
  emailNotifications    Boolean  @default(true) @map("email_notifications")
  taskAssignmentAlerts  Boolean  @default(true) @map("task_assignment_alerts")
  scanCompleteAlerts    Boolean  @default(true) @map("scan_complete_alerts")
  
  // API Keys (encrypted)
  openaiApiKey          String?  @map("openai_api_key")
  googleApiKey          String?  @map("google_api_key")
  semrushApiKey         String?  @map("semrush_api_key")
  ahrefsApiKey          String?  @map("ahrefs_api_key")
  
  // Theme
  defaultTheme          String   @default("light") @map("default_theme")         // "light" or "dark"
  
  // Metadata
  updatedAt             DateTime @updatedAt @map("updated_at")
  updatedBy             Int?     @map("updated_by")
  
  updater               User?    @relation("SettingsUpdater", fields: [updatedBy], references: [id])
  
  @@map("global_settings")
}
