generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             Int              @id @default(autoincrement())
  email          String           @unique
  passwordHash   String           @map("password_hash")
  name           String
  role           UserRole         @default(sales)
  
  // Granular permission system
  permissions        Json     @default("{}") // Feature flags (UserPermissions interface)
  permissionPreset   String   @default("sales_basic") @map("permission_preset") // sales_basic, sales_advanced, master_lite, master_full, custom
  
  territoryId    Int?             @map("territory_id")
  isActive       Boolean          @default(true) @map("is_active")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  lastLogin      DateTime?        @map("last_login")
  clientNotes    ClientNote[]
  leadHistory    LeadHistory[]
  assignedLeads  Lead[]           @relation("AssignedTo")
  notes          Note[]
  repPerformance RepPerformance[]
  stageMetrics   StageMetrics[]
  territory      Territory?       @relation(fields: [territoryId], references: [id])
  workOrders     WorkOrder[]
  
  // Commission system relations
  compensationConfig    UserCompensationConfig?
  compensationOverrides ClientCompensationOverride[]
  paymentTransactions   PaymentTransaction[]
  salesRepClients       ClientProfile[] @relation("SalesRep")
  masterClients         ClientProfile[] @relation("MasterManager")
  passwordResetTokens   PasswordResetToken[]
  
  // Bug reporting relations
  reportedBugs          BugReport[] @relation("BugReporter")
  assignedBugs          BugReport[] @relation("BugAssignee")
  resolvedBugs          BugReport[] @relation("BugResolver")
  
  // Contractor entity (for Wave AP payments — replaces waveVendorId)
  contractorVendorId    String?   @map("contractor_vendor_id")    // Wave vendor ID for AP bills
  contractorEntityName  String?   @map("contractor_entity_name")  // e.g. "Apex North"
  contractorEmail       String?   @map("contractor_email")        // Wave vendor billing email

  // Settings relations
  settingsUpdates       GlobalSettings[] @relation("SettingsUpdater")
  
  // Audit logging
  auditLogs             AuditLog[] @relation("AuditLogs")
  
  // Dashboard personalization
  dashboardLayout       Json?      @map("dashboard_layout")  // react-grid-layout serialized state
  
  // Task Pipeline relations
  assignedTasks         ClientTask[] @relation("TaskAssignee")
  createdTasks          ClientTask[] @relation("TaskAssigner")

  // Onboarding Portal
  generatedOnboardingTokens OnboardingToken[] @relation("OnboardingTokenCreator")
  
  // Rep onboarding flow
  repOnboardingCompletedAt  DateTime?  @map("rep_onboarding_completed_at")
  repOnboardingStep         Int        @default(0) @map("rep_onboarding_step") // last completed step (0 = not started)

  // Admin first-run wizard (9B / Sprint 17)
  adminOnboardingCompletedAt DateTime? @map("admin_onboarding_completed_at")
  adminOnboardingStep         Int       @default(0) @map("admin_onboarding_step") // last completed step index

  // Document Vault
  vaultUploads          VaultFile[]  @relation("VaultUploads")
  vaultPrivateFiles     VaultFile[]  @relation("VaultOwned")

  // Team messaging
  sentMessages          TeamMessage[] @relation("MessageAuthor")
  receivedMessages      TeamMessage[] @relation("MessageRecipient")
  messageReads          TeamMessageRead[]
  messageReactions      TeamMessageReaction[]
  pushSubscriptions     PushSubscription[]

  // Prospect history
  generatedAudits       ProspectAudit[] @relation("AuditGenerator")
  generatedDemos        ProspectDemo[]  @relation("DemoGenerator")

  // Position (job function — separate from dashboard role)
  positionId            Int?      @map("position_id")
  position              Position? @relation(fields: [positionId], references: [id])

  // Admin task queue
  assignedAdminTasks    AdminTask[] @relation("AdminTaskAssignee")
  createdAdminTasks     AdminTask[] @relation("AdminTaskCreator")

  // Operations Layer
  acknowledgedAlerts    AlertEvent[] @relation("AlertAcknowledger")
  notifications         NotificationEvent[]

  // Saved searches (Sprint 7A)
  savedSearches         SavedSearch[]

  // Dashboard usage events (FEAT-019)
  dashboardEvents       DashboardEvent[]

  // PM Import sessions (FEAT-014)
  pmImportSessions      PmImportSession[]

  // 2FA / TOTP (admin + master accounts only)
  // totpSecret is encrypted at rest — stored encrypted with server-side key
  totpEnabled           Boolean   @default(false) @map("totp_enabled")
  totpSecret            String?   @map("totp_secret")    // Encrypted TOTP secret
  totpVerifiedAt        DateTime? @map("totp_verified_at") // When 2FA was first verified
  totpBackupCodes       String?   @map("totp_backup_codes") // JSON array of hashed backup codes

  @@index([territoryId])
  @@index([positionId])
  @@map("users")
}

model Position {
  id                   Int       @id @default(autoincrement())
  name                 String    @unique
  type                 String    // "sales" | "management" | "operations" | "contractor"
  compensationType     String    @map("compensation_type")  // "commission_residual" | "management_fee" | "flat_monthly" | "per_deliverable" | "manual"
  defaultAmount        Decimal?  @map("default_amount") @db.Decimal(10, 2)
  defaultFrequency     String?   @map("default_frequency") // "monthly" | "per_close" | "per_deliverable" | "manual"
  dashboardAccessLevel String    @map("dashboard_access_level") // "admin" | "manager" | "sales" | "readonly"
  isActive             Boolean   @default(true) @map("is_active")
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  users                User[]

  @@map("positions")
}

model Territory {
  id           Int            @id @default(autoincrement())
  name         String
  cities       String[]
  zipCodes     String[]       @map("zip_codes")
  states       String[]
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  leads        Lead[]
  stageMetrics StageMetrics[]
  users        User[]

  @@map("territories")
}

model LeadSource {
  id          Int      @id @default(autoincrement())
  name        String
  type        String?
  costPerLead Decimal? @map("cost_per_lead") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  leads       Lead[]

  @@map("lead_sources")
}

model Lead {
  id                Int               @id @default(autoincrement())
  businessName      String            @map("business_name")
  website           String?
  phone             String
  email             String?
  address           String?
  city              String
  state             String
  zipCode           String            @map("zip_code")
  territoryId       Int?              @map("territory_id")
  assignedTo        Int?              @map("assigned_to")
  leadSourceId      Int?              @map("lead_source_id")
  status            LeadStatus        @default(available)
  statusChangedAt   DateTime          @default(now()) @map("status_changed_at")
  domainRating      Int?              @map("domain_rating")
  currentRank       Int?              @map("current_rank")
  reviewCount       Int?              @map("review_count")
  reviewAvg         Decimal?          @map("review_avg") @db.Decimal(3, 2)
  intelLastUpdated  DateTime?         @map("intel_last_updated")
  intelNeedsRefresh Boolean           @default(false) @map("intel_needs_refresh")
  dealValueTotal    Decimal           @default(0) @map("deal_value_total") @db.Decimal(10, 2)
  dealValueOneTime  Decimal           @default(0) @map("deal_value_one_time") @db.Decimal(10, 2)
  dealValueMonthly  Decimal           @default(0) @map("deal_value_monthly") @db.Decimal(10, 2)
  dealValueAnnual   Decimal           @default(0) @map("deal_value_annual") @db.Decimal(10, 2)
  mrr               Decimal           @default(0) @db.Decimal(10, 2)
  arr               Decimal           @default(0) @db.Decimal(10, 2)
  ltvEstimated      Decimal           @default(0) @map("ltv_estimated") @db.Decimal(10, 2)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  closeScore        Int?              @map("close_score")
  distanceFromMetro Decimal?          @map("distance_from_metro") @db.Decimal(6, 1)
  impactScore       Int?              @map("impact_score")
  marketType        String?           @map("market_type")
  pitchAngle        String?           @map("pitch_angle")
  priorityTier      String?           @map("priority_tier")
  suppressionSignal String?           @map("suppression_signal")
  wealthScore       String?           @map("wealth_score")
  clientProfile     ClientProfile?
  competitiveIntel  CompetitiveIntel?
  onboardingTokens  OnboardingToken[]
  onboardingSubmissions OnboardingSubmission[]
  dealProducts      DealProduct[]
  leadHistory       LeadHistory[]
  assignedUser      User?             @relation("AssignedTo", fields: [assignedTo], references: [id])
  leadSource        LeadSource?       @relation(fields: [leadSourceId], references: [id])
  territory         Territory?        @relation(fields: [territoryId], references: [id])
  notes             Note[]
  workOrders        WorkOrder[]
  vaultFiles        VaultFile[]
  prospectAudits    ProspectAudit[]
  prospectDemos     ProspectDemo[]

  @@index([territoryId])
  @@index([assignedTo])
  @@index([status])
  @@index([city, zipCode])
  @@index([leadSourceId])
  @@index([phone])
  @@index([territoryId, status])
  @@index([assignedTo, status])
  @@map("leads")
}

model Note {
  id        Int      @id @default(autoincrement())
  leadId    Int      @map("lead_id")
  userId    Int      @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("notes")
}

model LeadHistory {
  id                  Int         @id @default(autoincrement())
  leadId              Int         @map("lead_id")
  userId              Int?        @map("user_id")
  oldStatus           LeadStatus? @map("old_status")
  newStatus           LeadStatus  @map("new_status")
  timeInPreviousStage Int?        @map("time_in_previous_stage")
  notes               String?
  changedAt           DateTime    @default(now()) @map("changed_at")
  lead                Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user                User?       @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([changedAt(sort: Desc)])
  @@map("lead_history")
}

model CompetitiveIntel {
  id                   Int      @id @default(autoincrement())
  leadId               Int      @unique @map("lead_id")
  domainRating         Int?     @map("domain_rating")
  currentRank          Int?     @map("current_rank")
  backlinks            Int?
  reviewCount          Int?     @map("review_count")
  reviewAvg            Decimal? @map("review_avg") @db.Decimal(3, 2)
  siteSpeedMobile      Int?     @map("site_speed_mobile")
  siteSpeedDesktop     Int?     @map("site_speed_desktop")
  competitors          Json?
  drGap                Int?     @map("dr_gap")
  backlinkGap          Int?     @map("backlink_gap")
  reviewGap            Int?     @map("review_gap")
  speedGapMobile       Int?     @map("speed_gap_mobile")
  speedGapDesktop      Int?     @map("speed_gap_desktop")
  keywordGaps          Json?    @map("keyword_gaps")
  recommendedPackage   String?  @map("recommended_package")
  estimatedTimeToRank1 Int?     @map("estimated_time_to_rank_1")
  fetchedAt            DateTime @default(now()) @map("fetched_at")
  apiCosts             Decimal  @default(0.03) @map("api_costs") @db.Decimal(10, 4)
  lead                 Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([fetchedAt(sort: Desc)])
  @@map("competitive_intel")
}

model Product {
  id                  Int                  @id @default(autoincrement())
  name                String
  description         String?
  sku                 String               @unique
  category            String?
  price               Decimal              @db.Decimal(10, 2)
  pricingModel        PricingModel         @map("pricing_model")
  isActive            Boolean              @default(true) @map("is_active")
  displayOrder        Int                  @default(0) @map("display_order")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  dealProducts        DealProduct[]
  upsellOpportunities UpsellOpportunity[]

  @@index([isActive])
  @@index([category])
  @@map("products")
}

model DealProduct {
  id              Int      @id @default(autoincrement())
  leadId          Int      @map("lead_id")
  productId       Int      @map("product_id")
  quantity        Int      @default(1)
  priceAtSale     Decimal  @map("price_at_sale") @db.Decimal(10, 2)
  discountPercent Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  finalPrice      Decimal  @map("final_price") @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id])

  @@index([leadId])
  @@index([productId])
  @@map("deal_products")
}

model WorkOrder {
  id                    Int       @id @default(autoincrement())
  leadId                Int       @map("lead_id")
  userId                Int?      @map("user_id")
  executiveSummary      String?   @map("executive_summary")
  phasedRecommendations Json?     @map("phased_recommendations")
  pricingBreakdown      Json?     @map("pricing_breakdown")
  pdfUrl                String?   @map("pdf_url")
  fileSize              Int?      @map("file_size")
  sentViaEmail          Boolean   @default(false) @map("sent_via_email")
  emailSentAt           DateTime? @map("email_sent_at")
  viewedAt              DateTime? @map("viewed_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  lead                  Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user                  User?     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([sentViaEmail])
  @@map("work_orders")
}

model StageMetrics {
  id             Int        @id @default(autoincrement())
  stage          String
  territoryId    Int?       @map("territory_id")
  userId         Int?       @map("user_id")
  date           DateTime   @db.Date
  leadsCount     Int        @default(0) @map("leads_count")
  leadsEntered   Int        @default(0) @map("leads_entered")
  leadsExited    Int        @default(0) @map("leads_exited")
  conversionRate Decimal?   @map("conversion_rate") @db.Decimal(5, 2)
  avgTimeInStage Int?       @map("avg_time_in_stage")
  calculatedAt   DateTime   @default(now()) @map("calculated_at")
  territory      Territory? @relation(fields: [territoryId], references: [id], onDelete: Cascade)
  user           User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date(sort: Desc)])
  @@index([stage])
  @@index([territoryId])
  @@index([userId])
  @@map("stage_metrics")
}

model RepPerformance {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  date            DateTime @db.Date
  period          String
  leadsAssigned   Int      @default(0) @map("leads_assigned")
  leadsContacted  Int      @default(0) @map("leads_contacted")
  leadsWon        Int      @default(0) @map("leads_won")
  leadsLost       Int      @default(0) @map("leads_lost")
  conversionRate  Decimal? @map("conversion_rate") @db.Decimal(5, 2)
  totalRevenue    Decimal  @default(0) @map("total_revenue") @db.Decimal(10, 2)
  mrrAdded        Decimal  @default(0) @map("mrr_added") @db.Decimal(10, 2)
  arrAdded        Decimal  @default(0) @map("arr_added") @db.Decimal(10, 2)
  ltvAdded        Decimal  @default(0) @map("ltv_added") @db.Decimal(10, 2)
  avgDealSize     Decimal? @map("avg_deal_size") @db.Decimal(10, 2)
  notesAdded      Int      @default(0) @map("notes_added")
  workOrdersSent  Int      @default(0) @map("work_orders_sent")
  avgResponseTime Int?     @map("avg_response_time")
  calculatedAt    DateTime @default(now()) @map("calculated_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, period])
  @@index([userId])
  @@index([date(sort: Desc)])
  @@index([period])
  @@map("rep_performance")
}

model ClientProfile {
  id             Int                @id @default(autoincrement())
  leadId         Int                @unique @map("lead_id")
  businessName   String             @map("business_name")
  retainerAmount      Decimal              @default(2400) @map("retainer_amount") @db.Decimal(10, 2)
  healthScore         Int                  @default(50) @map("health_score")
  scanFrequency       String               @default("biweekly") @map("scan_frequency")
  voiceProfileId      String?              @map("voice_profile_id")
  status              String               @default("active")
  onboardedAt         DateTime             @default(now()) @map("onboarded_at")
  lastScanAt          DateTime?            @map("last_scan_at")
  nextScanAt          DateTime?            @map("next_scan_at")
  
  // Commission system fields
  salesRepId      Int?     @map("sales_rep_id")
  masterManagerId Int?     @map("master_manager_id")
  onboardedMonth  DateTime? @map("onboarded_month") @db.Date

  // Phase A: Lock-at-close residual tracking
  lockedResidualAmount  Decimal?  @map("locked_residual_amount") @db.Decimal(10, 2)
  closedInMonth         DateTime? @map("closed_in_month") @db.Date

  // Client Portal
  portalToken           String?   @unique @map("portal_token")

  // Reporting Schedule (Sprint 6)
  reportDeliveryDay     Int?      @map("report_delivery_day")     // 1, 5, or 15 — day of month to deliver
  reportDeliveryEmails  String[]  @map("report_delivery_emails")  // cc list, defaults to client lead email

  // Churn tracking
  churnedAt         DateTime? @map("churned_at")
  churnReason       String?   @map("churn_reason") @db.Text

  // Wave billing fields
  waveCustomerId    String?   @map("wave_customer_id")
  invoiceDay        Int       @default(1) @map("invoice_day")
  paymentTermsDays  Int       @default(7) @map("payment_terms_days")
  lastInvoiceDate   DateTime? @map("last_invoice_date")
  lastPaymentDate   DateTime? @map("last_payment_date")
  paymentStatus     String    @default("current") @map("payment_status")
  // "current" | "grace" | "overdue" | "paused" | "collections" | "terminated"

  invoiceRecords    InvoiceRecord[]
  
  competitors         ClientCompetitor[]
  domains             ClientDomain[]
  notes               ClientNote[]
  lead                Lead                 @relation(fields: [leadId], references: [id])
  reports             ClientReport[]
  tasks               ClientTask[]
  scans               CompetitiveScan[]
  upsellOpportunities UpsellOpportunity[]
  content             ClientContent[]
  voiceProfile        VoiceProfile?
  
  // Commission system relations
  salesRep             User?    @relation("SalesRep", fields: [salesRepId], references: [id])
  masterManager        User?    @relation("MasterManager", fields: [masterManagerId], references: [id])
  compensationOverrides ClientCompensationOverride[]
  paymentTransactions   PaymentTransaction[]

  // Website Studio
  webProperties         WebProperty[]
  // AI Cost Tracking
  aiCostLogs            AICostLog[]
  // Rank tracking
  keywordTrackers       KeywordTracker[]
  // Citation scans
  citationScans         CitationScan[]
  // Google Business Profile
  gbpConnection         GBPConnection?
  googleAdsConnection   GoogleAdsConnection?
  // Document Vault
  vaultFiles            VaultFile[]

  // Operations Layer
  alertEvents           AlertEvent[]
  recurringTaskRules    RecurringTaskRule[] @relation("RecurringTaskRuleClient")
  siteHealthSnapshots   SiteHealthSnapshot[]
  gbpSnapshots          GbpSnapshot[]
  websiteAudits         WebsiteAudit[]

  @@map("client_profiles")
}

model ClientCompetitor {
  id            Int           @id @default(autoincrement())
  clientId      Int           @map("client_id")
  businessName  String        @map("business_name")
  domain        String?
  googlePlaceId String?       @map("google_place_id")
  isActive      Boolean       @default(true) @map("is_active")
  addedAt       DateTime      @default(now()) @map("added_at")
  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_competitors")
}

model ClientDomain {
  id              Int           @id @default(autoincrement())
  clientId        Int           @map("client_id")
  domain          String
  type            String
  hosting         String
  wpUrl           String?       @map("wp_url")
  wpUsername      String?       @map("wp_username")
  wpAppPassword   String?       @map("wp_app_password")
  vercelProjectId String?       @map("vercel_project_id")
  githubRepo      String?       @map("github_repo")
  templateUsed    String?       @map("template_used")
  ownershipType   String        @default("ghm") @map("ownership_type")
  dnsVerified     Boolean       @default(false) @map("dns_verified")
  sslActive       Boolean       @default(false) @map("ssl_active")
  contentCount    Int           @default(0) @map("content_count")
  lastDeployedAt  DateTime?     @map("last_deployed_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  siteHealthSnapshots SiteHealthSnapshot[]

  @@index([clientId])
  @@map("client_domains")
}

model ClientTask {
  id              Int           @id @default(autoincrement())
  clientId        Int           @map("client_id")
  title           String
  description     String?
  category        String
  priority        String        @default("P3")
  status          String        @default("queued")
  source          String        @default("manual")
  assignedTo      String?       @map("assigned_to")          // DEPRECATED — use assignedToUserId
  targetKeywords  Json?         @map("target_keywords")
  competitorRef   String?       @map("competitor_ref")
  contentBrief    Json?         @map("content_brief")
  draftContent    String?       @map("draft_content")
  approvedContent String?       @map("approved_content")
  deployedUrl     String?       @map("deployed_url")
  outcomeMetrics  Json?         @map("outcome_metrics")
  dueDate         DateTime?     @map("due_date")
  scanId          Int?          @map("scan_id")
  domainId        Int?          @map("domain_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deployedAt      DateTime?     @map("deployed_at")
  measuredAt      DateTime?     @map("measured_at")
  
  // ── Task Pipeline additions ────────────────────────────────────────────────
  assignedToUserId  Int?        @map("assigned_to_user_id")   // Proper FK — who owns this task right now
  assignedByUserId  Int?        @map("assigned_by_user_id")   // Who created or assigned
  startedAt         DateTime?   @map("started_at")            // When work actually began
  completedAt       DateTime?   @map("completed_at")          // When finished (approved/deployed/done)
  statusChangedAt   DateTime    @default(now()) @map("status_changed_at") // Last status transition
  estimatedMinutes  Int?        @map("estimated_minutes")     // Time estimate for queue planning
  sortOrder         Int         @default(0) @map("sort_order")// Manual queue ordering (lower = higher priority)
  
  // ── Operations Layer additions ───────────────────────────────────────────
  recurringRuleId   Int?        @map("recurring_rule_id")   // FK to RecurringTaskRule
  sourceAlertId     Int?        @map("source_alert_id")     // FK to AlertEvent (alert-originated tasks)
  blockedReason     String?     @map("blocked_reason")       // Why task is blocked
  checklistComplete Boolean     @default(false) @map("checklist_complete") // Quick filter for completed checklists

  // Relations
  notes             ClientNote[]
  transitions       TaskTransition[]
  client            ClientProfile      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assignedToUser    User?              @relation("TaskAssignee", fields: [assignedToUserId], references: [id])
  assignedByUser    User?              @relation("TaskAssigner", fields: [assignedByUserId], references: [id])
  recurringRule     RecurringTaskRule? @relation(fields: [recurringRuleId], references: [id])
  checklistItems    TaskChecklistItem[]
  alertLinks        TaskAlertLink[]

  @@index([clientId, status])
  @@index([clientId, category])
  @@index([clientId, priority])
  @@index([assignedToUserId, status])
  @@index([assignedToUserId, priority])
  @@index([status, priority])
  @@index([dueDate])
  @@map("client_tasks")
}

model ClientNote {
  id        Int           @id @default(autoincrement())
  clientId  Int           @map("client_id")
  taskId    Int?          @map("task_id")
  authorId  Int           @map("author_id")
  type      String
  content   String
  isPinned  Boolean       @default(false) @map("is_pinned")
  tags      Json?
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  author    User          @relation(fields: [authorId], references: [id])
  client    ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  task      ClientTask?   @relation(fields: [taskId], references: [id])

  @@index([clientId, type])
  @@index([clientId, isPinned])
  @@index([taskId])
  @@map("client_notes")
}

// ============================================================================
// TASK PIPELINE — STATUS TRANSITION HISTORY
// ============================================================================

model TaskTransition {
  id          Int        @id @default(autoincrement())
  taskId      Int        @map("task_id")
  fromStatus  String?    @map("from_status")   // null for initial creation
  toStatus    String     @map("to_status")
  userId      Int?       @map("user_id")        // Who made the transition
  comment     String?                           // Optional note (rejection reason, etc.)
  createdAt   DateTime   @default(now()) @map("created_at")
  
  task        ClientTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@map("task_transitions")
}

model CompetitiveScan {
  id                  Int                  @id @default(autoincrement())
  clientId            Int                  @map("client_id")
  scanDate            DateTime             @default(now()) @map("scan_date")
  clientData          Json                 @map("client_data")
  competitors         Json
  deltas              Json
  alerts              Json
  healthScore         Int                  @map("health_score")
  apiCosts            Json?                @map("api_costs")
  status              String               @default("complete")
  client              ClientProfile        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  upsellOpportunities UpsellOpportunity[]

  @@index([clientId, scanDate(sort: Desc)])
  @@map("competitive_scans")
}

model ClientReport {
  id           Int           @id @default(autoincrement())
  clientId     Int           @map("client_id")
  type         String
  periodStart  DateTime      @map("period_start")
  periodEnd    DateTime      @map("period_end")
  content      Json
  pdfUrl       String?       @map("pdf_url")
  sentToClient Boolean       @default(false) @map("sent_to_client")
  sentAt       DateTime?     @map("sent_at")        // When the report email was delivered
  createdAt    DateTime      @default(now()) @map("created_at")
  client       ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, type])
  @@map("client_reports")
}

model DiscoveryRun {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  vertical     String
  locations    Json
  filters      Json
  resultsCount Int      @map("results_count")
  pushedCount  Int      @default(0) @map("pushed_count")
  resultsCache Json?    @map("results_cache")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("discovery_runs")
}

model LocationPreset {
  id        Int      @id @default(autoincrement())
  name      String
  locations Json
  createdAt DateTime @default(now()) @map("created_at")

  @@map("location_presets")
}

model UpsellOpportunity {
  id              Int           @id @default(autoincrement())
  clientId        Int           @map("client_id")
  productId       Int           @map("product_id")
  scanId          Int?          @map("scan_id")
  status          String        @default("detected")
  opportunityScore Int          @map("opportunity_score")
  gapCategory     String        @map("gap_category")
  reasoning       String
  projectedMrr    Decimal       @map("projected_mrr") @db.Decimal(10, 2)
  projectedRoi    Decimal?      @map("projected_roi") @db.Decimal(5, 2)
  presentedAt     DateTime?     @map("presented_at")
  respondedAt     DateTime?     @map("responded_at")
  response        String?
  detectedAt      DateTime      @default(now()) @map("detected_at")
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])
  scan            CompetitiveScan? @relation(fields: [scanId], references: [id])

  @@index([clientId, status])
  @@index([status])
  @@index([opportunityScore(sort: Desc)])
  @@map("upsell_opportunities")
}

// ============================================================================
// COMMISSION SYSTEM TABLES
// ============================================================================

model UserCompensationConfig {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique @map("user_id")
  
  // Commission settings
  commissionEnabled  Boolean  @default(true) @map("commission_enabled")
  commissionAmount   Decimal  @default(1000) @map("commission_amount") @db.Decimal(10, 2)
  
  // Residual settings
  residualEnabled    Boolean  @default(true) @map("residual_enabled")
  residualAmount     Decimal  @default(200) @map("residual_amount") @db.Decimal(10, 2)
  residualStartMonth Int      @default(2) @map("residual_start_month")
  
  // Manager settings (for managers only)
  masterFeeEnabled   Boolean  @default(false) @map("master_fee_enabled")
  masterFeeAmount    Decimal  @default(240) @map("master_fee_amount") @db.Decimal(10, 2)
  
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_compensation_config")
}

model ClientCompensationOverride {
  id                Int      @id @default(autoincrement())
  clientId          Int      @map("client_id")
  userId            Int      @map("user_id")
  
  // Override settings (null = use user default)
  commissionAmount  Decimal? @map("commission_amount") @db.Decimal(10, 2)
  residualAmount    Decimal? @map("residual_amount") @db.Decimal(10, 2)
  feeAmount         Decimal? @map("fee_amount") @db.Decimal(10, 2)
  
  reason            String?  // Why this client is different
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  client            ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([clientId, userId])
  @@map("client_compensation_overrides")
}

model PaymentTransaction {
  id              Int      @id @default(autoincrement())
  clientId        Int      @map("client_id")
  userId          Int      @map("user_id")
  
  type            String   // "commission" | "residual" | "master_fee"
  amount          Decimal  @db.Decimal(10, 2)
  month           DateTime @db.Date
  
  status          String   @default("pending") // "pending" | "paid" | "held" | "cancelled"
  paidAt          DateTime? @map("paid_at")
  notes           String?

  // Wave integration
  waveInvoiceId   String?   @map("wave_invoice_id")
  waveBillId      String?   @map("wave_bill_id")
  waveCustomerId  String?   @map("wave_customer_id")
  wavePaymentId   String?   @map("wave_payment_id")
  paymentMethod   String?   @map("payment_method")   // "ach" | "credit_card" | "check" | "manual"
  processingFee   Decimal?  @map("processing_fee") @db.Decimal(10, 2)
  
  // Idempotency — Wave invoice ID or cron run identifier (prevents double-pay on webhook retry)
  sourceEventId   String?   @map("source_event_id")

  // Historical import flag — true for records seeded from Wave history (pre-Jan 1 2026)
  isHistorical    Boolean   @default(false) @map("is_historical")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, month])
  @@index([clientId, month])
  @@index([status])
  @@map("payment_transactions")
}

enum UserRole {
  admin   // Super-admin: can manage admins + managers, full system access
  manager // Manager-level: territory management, team ops
  sales   // Sales rep: territory-scoped access
}

enum LeadStatus {
  available
  scheduled
  contacted
  follow_up
  paperwork
  won
  lost_rejection
  lost_deferred
}

enum PricingModel {
  one_time
  monthly
  annual
}

// ============================================================================
// CONTENT GENERATION SYSTEM
// ============================================================================

model ClientContent {
  id           Int            @id @default(autoincrement())
  clientId     Int            @map("client_id")
  contentType  String         @map("content_type") // "blog", "social", "meta"
  title        String?
  content      String         @db.Text
  keywords     String[]
  status       String         @default("draft") // "draft", "review", "approved", "published", "scheduled"
  scheduledFor DateTime?      @map("scheduled_for")
  publishedAt  DateTime?      @map("published_at")
  metadata     Json?          // Store AI generation parameters, platform-specific data
  currentVersion Int         @default(1) @map("current_version")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  
  client       ClientProfile  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  versions     ContentVersion[]
  
  @@index([clientId, status])
  @@index([clientId, contentType])
  @@index([scheduledFor])
  @@map("client_content")
}

// ============================================================================
// VOICE PROFILE SYSTEM (SCRVNR)
// ============================================================================

model VoiceProfile {
  id                String   @id // voice_xxxxx_yyyyy format
  clientId          Int      @unique @map("client_id")
  tonality          String   @db.Text
  vocabulary        String[] // Array of key terms
  sentenceStructure String   @db.Text
  formality         Int      // 1-10 scale
  enthusiasm        Int      // 1-10 scale
  technicality      Int      // 1-10 scale
  brevity           Int      // 1-10 scale
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  client            ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("voice_profiles")
}

// ============================================================================
// CONTENT VERSIONING SYSTEM
// ============================================================================

model ContentVersion {
  id              Int      @id @default(autoincrement())
  contentId       Int      @map("content_id")
  versionNumber   Int      @map("version_number")
  title           String?
  content         String   @db.Text
  keywords        String[]
  metadata        Json?    // Store generation parameters
  changeNote      String?  @map("change_note") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       Int      @map("created_by")
  
  clientContent   ClientContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@index([contentId, versionNumber])
  @@map("content_versions")
}

// ============================================================================
// BUG REPORTING SYSTEM
// ============================================================================

model BugReport {
  id                Int      @id @default(autoincrement())
  
  // Reporter info
  userId            Int?     @map("user_id")
  userEmail         String?  @map("user_email")
  userName          String?  @map("user_name")
  
  // Bug details
  type              String   @default("bug") // "bug" | "feature"
  title             String
  description       String   @db.Text
  category          String   // "content", "compensation", "scans", "clients", "leads", "ui", "performance", "other"
  severity          String   @default("medium") // "low", "medium", "high", "critical"
  status            String   @default("new") // "new", "acknowledged", "in-progress", "resolved", "wont-fix"
  
  // Auto-captured metadata
  pageUrl           String   @map("page_url")
  userAgent         String   @map("user_agent")
  screenResolution  String   @map("screen_resolution")
  timestamp         DateTime @default(now())
  
  // Technical context
  browserInfo       Json?    @map("browser_info")  // Browser name, version, OS
  consoleErrors     Json?    @map("console_errors") // Last 10 console errors
  networkErrors     Json?    @map("network_errors") // Failed requests
  recentActions     Json?    @map("recent_actions") // User's last 5 actions
  sessionData       Json?    @map("session_data")   // Relevant session state
  
  // Assignment
  assignedTo        Int?     @map("assigned_to")    // Always David Kirsch initially
  priority          String   @default("high")       // "low", "medium", "high", "top"
  
  // Resolution
  resolvedAt        DateTime? @map("resolved_at")
  resolvedBy        Int?      @map("resolved_by")
  resolutionNotes   String?   @map("resolution_notes") @db.Text
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  user              User?     @relation("BugReporter", fields: [userId], references: [id])
  assignee          User?     @relation("BugAssignee", fields: [assignedTo], references: [id])
  resolver          User?     @relation("BugResolver", fields: [resolvedBy], references: [id])
  
  @@index([status, priority])
  @@index([category])
  @@index([assignedTo])
  @@index([createdAt(sort: Desc)])
  @@map("bug_reports")
}

// ============================================================================
// GLOBAL SETTINGS
// ============================================================================

// Password reset tokens — generated on forgot-password request, consumed on reset
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model GlobalSettings {
  id                    Int      @id @default(autoincrement())
  
  // Commission Defaults
  defaultCommission     Float    @default(0.15) @map("default_commission")       // 15%
  defaultResidual       Float    @default(0.05) @map("default_residual")         // 5%
  masterManagerFee      Float    @default(240) @map("master_manager_fee")        // $240/mo

  // Phase A: Upsell commission rate
  upsellCommissionRate  Float    @default(0.10) @map("upsell_commission_rate")   // 10% of product price

  // Phase A: Tiered residual thresholds (retainer amount → residual payout)
  // Tier 1: retainer < tier2Threshold → residualTier1Amount
  // Tier 2: retainer < tier3Threshold → residualTier2Amount
  // Tier 3: retainer >= tier3Threshold → residualTier3Amount
  residualTier1Amount   Float    @default(200) @map("residual_tier1_amount")     // $200/mo (base)
  residualTier2Amount   Float    @default(250) @map("residual_tier2_amount")     // $250/mo
  residualTier3Amount   Float    @default(300) @map("residual_tier3_amount")     // $300/mo
  residualTier2Threshold Float   @default(3000) @map("residual_tier2_threshold") // retainer >= $3000 → tier 2
  residualTier3Threshold Float   @default(4000) @map("residual_tier3_threshold") // retainer >= $4000 → tier 3

  // Feature Toggles
  contentStudioEnabled  Boolean  @default(true) @map("content_studio_enabled")
  scanningEnabled       Boolean  @default(true) @map("scanning_enabled")
  voiceCaptureEnabled   Boolean  @default(true) @map("voice_capture_enabled")
  bugReportingEnabled   Boolean  @default(true) @map("bug_reporting_enabled")
  
  // Scan Settings
  scanFrequencyDays     Int      @default(30) @map("scan_frequency_days")
  scanCostLimit         Float    @default(100) @map("scan_cost_limit")          // $100/mo
  
  // Notification Settings
  emailNotifications    Boolean  @default(true) @map("email_notifications")
  taskAssignmentAlerts  Boolean  @default(true) @map("task_assignment_alerts")
  scanCompleteAlerts    Boolean  @default(true) @map("scan_complete_alerts")
  pushMessagesEnabled   Boolean  @default(true) @map("push_messages_enabled")
  pushTasksEnabled      Boolean  @default(true) @map("push_tasks_enabled")
  
  // API Keys (encrypted)
  openaiApiKey          String?  @map("openai_api_key")
  googleApiKey          String?  @map("google_api_key")
  semrushApiKey         String?  @map("semrush_api_key")
  ahrefsApiKey          String?  @map("ahrefs_api_key")
  
  // Theme
  defaultTheme          String   @default("light") @map("default_theme")         // "light" or "dark"
  
  // Monthly Goals (null = disabled/not set)
  goalsEnabled          Boolean  @default(false) @map("goals_enabled")
  monthlyDealTarget     Int?     @map("monthly_deal_target")
  monthlyRevenueTarget  Float?   @map("monthly_revenue_target")

  // Branding (9B/9C — admin first-run wizard)
  companyName           String?  @map("company_name")
  companyTagline        String?  @map("company_tagline")
  logoUrl               String?  @map("logo_url")          // Vercel Blob URL
  brandColor            String?  @map("brand_color")       // hex e.g. "#1a56db" — primary (CTAs)
  brandColorSecondary   String?  @map("brand_color_secondary") // supporting UI elements
  brandColorAccent      String?  @map("brand_color_accent")    // highlights / badges
  
  // Metadata
  updatedAt             DateTime @updatedAt @map("updated_at")
  updatedBy             Int?     @map("updated_by")
  
  updater               User?    @relation("SettingsUpdater", fields: [updatedBy], references: [id])
  
  @@map("global_settings")
}
// Add this to the end of your schema.prisma file

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id                Int       @id @default(autoincrement())
  
  // Who
  userId            Int       @map("user_id")
  userName          String    @map("user_name")
  userEmail         String    @map("user_email")
  userRole          String    @map("user_role")
  
  // What
  action            String                    // "page_access", "api_call", "permission_check", "data_export", etc.
  resource          String?                   // "/master", "/api/leads", "lead:123", etc.
  permission        String?                   // "view_analytics", "manage_leads", etc.
  method            String?                   // "GET", "POST", "PUT", "DELETE"
  
  // When
  timestamp         DateTime  @default(now())
  
  // Where
  ipAddress         String?   @map("ip_address")
  userAgent         String?   @map("user_agent")
  
  // Result
  status            String                    // "success", "denied", "error"
  statusCode        Int?      @map("status_code")         // HTTP status code
  errorMessage      String?   @map("error_message")
  
  // Additional Context
  metadata          Json?                     // Any additional data (request params, response data, etc.)
  duration          Int?                      // Request duration in ms
  
  // Relations
  user              User      @relation("AuditLogs", fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([status])
  @@index([resource])
  @@map("audit_logs")
}


// TEAM MESSAGING
// ============================================================================

// ─── Website Audit (FEAT-024) ─────────────────────────────────────────────────
model WebsiteAudit {
  id          Int      @id @default(autoincrement())
  clientId    Int      @map("client_id")
  url         String   // audited URL
  runAt       DateTime @default(now()) @map("run_at")

  // Scores (0–100)
  scorePerformance    Int? @map("score_performance")
  scoreAccessibility  Int? @map("score_accessibility")
  scoreSeo            Int? @map("score_seo")
  scoreBestPractices  Int? @map("score_best_practices")

  // Meta
  metaTitle           String?  @map("meta_title")
  metaDescription     String?  @map("meta_description")
  h1                  String?
  canonical           String?
  hasSitemap          Boolean? @map("has_sitemap")
  hasRobots           Boolean? @map("has_robots")
  ssl                 Boolean?
  mobile              Boolean?

  // Full JSON payload from PageSpeed (for export/drill-down)
  rawJson     Json?    @map("raw_json")

  // Issues list: [{ category, severity, description }]
  issues      Json?

  client      ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, runAt(sort: Desc)])
  @@map("website_audits")
}

model TeamMessage {
  id              Int      @id @default(autoincrement())
  
  content         String   @db.Text
  
  // Who sent it
  authorId        Int      @map("author_id")
  author          User     @relation("MessageAuthor", fields: [authorId], references: [id])
  
  // Who it's for: "all", "role:master", "role:sales", or specific userId
  audienceType    String   @default("all") @map("audience_type")  // "all" | "role" | "user"
  audienceValue   String?  @map("audience_value")                  // role name or user id string
  
  // For direct replies — parent message id
  parentId        Int?     @map("parent_id")
  parent          TeamMessage?  @relation("Replies", fields: [parentId], references: [id])
  replies         TeamMessage[] @relation("Replies")
  
  // If direct message, who is the recipient (for notifications/unread count)
  recipientId     Int?     @map("recipient_id")
  recipient       User?    @relation("MessageRecipient", fields: [recipientId], references: [id])
  
  // Pinned messages stay at top of feed on dashboard
  isPinned        Boolean  @default(false) @map("is_pinned")
  
  // Priority: "normal" | "important" | "urgent"
  priority        String   @default("normal")

  // File attachments (stored in Vercel Blob, optionally promoted to Vault)
  attachmentUrl      String?  @map("attachment_url")
  attachmentName     String?  @map("attachment_name")
  attachmentSize     Int?     @map("attachment_size")
  attachmentMimeType String?  @map("attachment_mime_type")
  attachmentVaultId  Int?     @map("attachment_vault_id")   // set if promoted to vault
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  reads           TeamMessageRead[]
  reactions       TeamMessageReaction[]
  
  @@index([authorId])
  @@index([recipientId])
  @@index([parentId])
  @@index([createdAt])
  @@map("team_messages")
}

model TeamMessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int      @map("message_id")
  userId    Int      @map("user_id")
  emoji     String   // Unicode emoji e.g. "👍" "❤️" "😂"
  createdAt DateTime @default(now()) @map("created_at")

  message   TeamMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("team_message_reactions")
}

model TeamMessageRead {
  id        Int      @id @default(autoincrement())
  messageId Int      @map("message_id")
  userId    Int      @map("user_id")
  readAt    DateTime @default(now()) @map("read_at")
  
  message   TeamMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId])
  @@index([userId])
  @@map("team_message_reads")
}

// ============================================================================
// PUSH SUBSCRIPTIONS
// ============================================================================

model PushSubscription {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  endpoint    String   @db.Text
  p256dh      String   @db.Text
  auth        String   @db.Text
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

// ============================================================================
// PUSH NOTIFICATION SUBSCRIPTIONS
// ============================================================================


// ============================================================================
// WEBSITE STUDIO
// ============================================================================

model WebProperty {
  id                     Int       @id @default(autoincrement())
  clientId               Int       @map("client_id")
  slug                   String                        // e.g. "gad-bmw-t1"
  tier                   String                        // "tier1" | "tier2" | "tier3"
  brandSegment           String    @map("brand_segment")   // e.g. "BMW", "Audi"
  targetUrl              String    @map("target_url")       // Final domain or subdomain
  vercelProjectId        String?   @map("vercel_project_id")
  voiceProfileSlug       String?   @map("voice_profile_slug") // Matches scrvnr/profiles/*.json stem
  deployStatus           String    @default("scaffolded") @map("deploy_status")
  lastDeployedAt         DateTime? @map("last_deployed_at")
  dnsVerified            Boolean   @default(false) @map("dns_verified")
  sslActive              Boolean   @default(false) @map("ssl_active")
  sslExpiresAt           DateTime? @map("ssl_expires_at")
  stalenessThresholdDays Int       @default(90) @map("staleness_threshold_days")
  isArchived             Boolean   @default(false) @map("is_archived")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  client      ClientProfile      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dnaCaptures DnaCapture[]
  buildJobs   BuildJob[]

  @@unique([clientId, slug])
  @@index([clientId])
  @@index([clientId, brandSegment])
  @@index([deployStatus])
  @@map("web_properties")
}

model DnaCapture {
  id            Int       @id @default(autoincrement())
  propertyId    Int       @map("property_id")
  sourceUrl     String    @map("source_url")
  capturedAt    DateTime  @default(now()) @map("captured_at")
  capturedBy    String?   @map("captured_by")
  tokenBlob     Json      @map("token_blob")   // Full DnaTokenBlob JSON
  overrideCount Int       @default(0) @map("override_count")
  isSuperseded  Boolean   @default(false) @map("is_superseded")

  property  WebProperty       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  overrides DnaTokenOverride[]

  @@index([propertyId])
  @@index([propertyId, isSuperseded])
  @@map("dna_captures")
}

model DnaTokenOverride {
  id             Int       @id @default(autoincrement())
  captureId      Int       @map("capture_id")
  tokenKey       String    @map("token_key")       // e.g. "colors.primary"
  originalValue  String    @db.Text @map("original_value")  // JSON-serialized
  overrideValue  String    @db.Text @map("override_value")  // JSON-serialized
  note           String    @db.Text                // Required — operator explains the change
  operatorName   String    @map("operator_name")
  isLocked       Boolean   @default(false) @map("is_locked")
  createdAt      DateTime  @default(now()) @map("created_at")

  capture DnaCapture @relation(fields: [captureId], references: [id], onDelete: Cascade)

  @@index([captureId])
  @@index([captureId, tokenKey])
  @@map("dna_token_overrides")
}

model BuildJob {
  id               Int       @id @default(autoincrement())
  propertyId       Int       @map("property_id")
  stage            String    @default("scaffolded")  // BuildStage enum
  assignedTo       String?   @map("assigned_to")
  scaffoldManifest Json?     @map("scaffold_manifest")
  pageCount        Int       @default(0) @map("page_count")
  pagesCleared     Int       @default(0) @map("pages_cleared")
  pagesApproved    Int       @default(0) @map("pages_approved")
  deployAttempts   Int       @default(0) @map("deploy_attempts")
  lastDeployError  String?   @db.Text @map("last_deploy_error")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  property WebProperty    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  pages    ComposerPage[]

  @@index([propertyId])
  @@index([propertyId, stage])
  @@map("build_jobs")
}

model ComposerPage {
  id              Int       @id @default(autoincrement())
  jobId           Int       @map("job_id")
  slug            String                        // e.g. "common-problems"
  title           String
  filePath        String    @map("file_path")   // Relative to scaffold root
  sections        Json      @default("{}")      // { sectionName: copyText }
  scrvnrStatus    String    @default("unprocessed") @map("scrvnr_status")
  lastScrvnrResult Json?    @map("last_scrvnr_result")  // ScrvnrResultSummary
  reviewStatus    String    @default("pending") @map("review_status")
  reviewNote      String?   @db.Text @map("review_note")
  pageOrder       Int       @default(0) @map("page_order")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  job           BuildJob          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  scrvnrResults ScrvnrGateResult[]

  @@index([jobId])
  @@index([jobId, scrvnrStatus])
  @@index([jobId, reviewStatus])
  @@map("composer_pages")
}

model ScrvnrGateResult {
  id                  Int       @id @default(autoincrement())
  pageId              Int       @map("page_id")
  propertySlug        String    @map("property_slug")
  voiceProfileSlug    String?   @map("voice_profile_slug")
  gateOpen            Boolean   @map("gate_open")
  gateStatus          String    @map("gate_status")   // "PASS" | "FAIL" | "OVERRIDE" | "ERROR"
  overrideApplied     Boolean   @default(false) @map("override_applied")
  overrideNote        String?   @db.Text @map("override_note")
  pass1Score          Float     @map("pass1_score")
  pass1Pass           Boolean   @map("pass1_pass")
  pass2Score          Float?    @map("pass2_score")
  pass2Pass           Boolean?  @map("pass2_pass")
  sectionsEvaluated   String[]  @map("sections_evaluated")
  failedSections      String[]  @map("failed_sections")
  rawResult           Json      @map("raw_result")    // Full adapter response
  evaluatedAt         DateTime  @default(now()) @map("evaluated_at")

  page ComposerPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([pageId, evaluatedAt(sort: Desc)])
  @@map("scrvnr_gate_results")
}


// ── AI Cost Logging ────────────────────────────────────────────────────────────
// Adapted from GREGORE metabolism engine — reshaped for USD/per-client tracking

// ============================================================================
// ONBOARDING PORTAL
// ============================================================================

model OnboardingToken {
  id            Int       @id @default(autoincrement())
  token         String    @unique                          // UUID v4, used in URL
  leadId        Int       @map("lead_id")
  generatedBy   Int       @map("generated_by")             // Partner user ID

  status        String    @default("pending")              // "pending" | "in_progress" | "completed" | "expired"

  currentStep   Int       @default(1) @map("current_step")
  formData      Json?     @map("form_data")                // Partial saves between steps

  completedAt   DateTime? @map("completed_at")
  submittedData Json?     @map("submitted_data")           // Final submission snapshot

  expiresAt     DateTime  @map("expires_at")               // 30 days from generation
  lastAccessedAt DateTime? @map("last_accessed_at")
  accessCount   Int       @default(0) @map("access_count")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  lead          Lead      @relation(fields: [leadId], references: [id])
  generatedByUser User    @relation("OnboardingTokenCreator", fields: [generatedBy], references: [id])
  submission    OnboardingSubmission?

  @@index([token])
  @@index([leadId])
  @@index([status])
  @@map("onboarding_tokens")
}

model OnboardingSubmission {
  id              Int       @id @default(autoincrement())
  tokenId         Int       @unique @map("token_id")
  leadId          Int       @map("lead_id")

  // Section 1: Business Identity
  businessName    String    @map("business_name")
  address         String
  city            String
  state           String
  zipCode         String    @map("zip_code")
  phone           String
  website         String?
  businessDescription String? @map("business_description")
  primaryServices Json?     @map("primary_services")        // Array of strings
  serviceAreas    String?   @map("service_areas")
  multiLocation   Boolean   @default(false) @map("multi_location")
  locationCount   Int?      @map("location_count")

  // Section 2: Contacts
  primaryContactName    String  @map("primary_contact_name")
  primaryContactTitle   String? @map("primary_contact_title")
  primaryContactEmail   String  @map("primary_contact_email")
  primaryContactPhone   String  @map("primary_contact_phone")
  preferredContactMethod String? @map("preferred_contact_method")

  billingSameAsPrimary  Boolean @default(true) @map("billing_same_as_primary")
  billingContactName    String? @map("billing_contact_name")
  billingContactEmail   String? @map("billing_contact_email")
  billingContactPhone   String? @map("billing_contact_phone")
  paymentMethod         String? @map("payment_method")
  requiresPO            Boolean @default(false) @map("requires_po")
  poNumber              String? @map("po_number")

  // Section 3: Technical Access (JSON blob)
  technicalAccess Json     @map("technical_access")

  // Section 4: Competitive Landscape + Content Prefs
  competitors       Json?
  competitorPains   Json?   @map("competitor_pains")
  competitorNotes   String? @map("competitor_notes")
  contentFocusTopics String? @map("content_focus_topics")
  contentAvoidTopics String? @map("content_avoid_topics")
  tonePreference    String? @map("tone_preference")
  contentReviewPref String? @map("content_review_pref")

  // Section 5: Brand + Online Presence
  hasLogo           Boolean @default(false) @map("has_logo")
  hasBrandGuidelines Boolean @default(false) @map("has_brand_guidelines")
  hasPhotography    Boolean @default(false) @map("has_photography")
  socialProfiles    Json?   @map("social_profiles")
  directoryListings String? @map("directory_listings")
  previousSEO       Boolean @default(false) @map("previous_seo")
  previousSEONotes  String? @map("previous_seo_notes")

  additionalNotes   String? @map("additional_notes")

  // Ops tracking
  opsChecklist      Json?   @map("ops_checklist")
  onboardingComplete Boolean  @default(false) @map("onboarding_complete")
  onboardedAt        DateTime? @map("onboarded_at")
  onboardedBy        Int?      @map("onboarded_by")

  submittedAt   DateTime  @default(now()) @map("submitted_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  token         OnboardingToken @relation(fields: [tokenId], references: [id])
  lead          Lead            @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([onboardingComplete])
  @@map("onboarding_submissions")
}

model AICostLog {
  id               Int      @id @default(autoincrement())
  timestamp        DateTime @default(now())
  feature          String   // AIFeature enum values
  clientId         Int      @map("client_id")
  modelId          String   @map("model_id")
  inputTokens      Int      @map("input_tokens")
  outputTokens     Int      @map("output_tokens")
  costUSD          Float    @map("cost_usd")
  estimatedCostUSD Float?   @map("estimated_cost_usd")  // For accuracy tracking
  latencyMs        Int      @map("latency_ms")
  qualityScore     Float?   @map("quality_score")       // Set retroactively (e.g., if SCRVNR passes)

  client ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([feature])
  @@index([timestamp(sort: Desc)])
  @@index([clientId, timestamp(sort: Desc)])
  @@map("ai_cost_logs")
}


// ============================================================================
// WAVE PAYMENTS — INVOICE MIRROR
// ============================================================================

model InvoiceRecord {
  id              Int       @id @default(autoincrement())
  clientId        Int       @map("client_id")
  waveInvoiceId   String    @unique @map("wave_invoice_id")
  invoiceNumber   String?   @map("invoice_number")
  amount          Decimal   @db.Decimal(10, 2)
  status          String    @default("draft")
  // "draft" | "sent" | "viewed" | "paid" | "overdue" | "cancelled"
  issuedDate      DateTime  @map("issued_date")
  dueDate         DateTime  @map("due_date")
  paidDate        DateTime? @map("paid_date")
  paidAmount      Decimal?  @map("paid_amount") @db.Decimal(10, 2)
  paymentMethod   String?   @map("payment_method")
  waveViewUrl     String?   @map("wave_view_url")
  lineItems       Json?     @map("line_items")
  notes           String?
  sourceTaskId    Int?      @map("source_task_id")   // set when auto-generated from a task deployment
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, status])
  @@index([dueDate])
  @@index([status])
  @@map("invoice_records")
}

// ============================================================================
// WEBHOOK EVENTS — Audit log for all inbound webhooks (Wave, etc.)
// ============================================================================

model WebhookEvent {
  id           Int      @id @default(autoincrement())
  source       String                         // "wave"
  eventType    String   @map("event_type")    // "invoice.paid", "invoice.created", etc.
  externalId   String   @map("external_id")  // Wave's event ID — dedup key
  rawPayload   Json     @map("raw_payload")   // Full webhook body (for replay)
  status       String   @default("received") // "received" | "processed" | "failed" | "replayed"
  error        String?
  processedAt  DateTime? @map("processed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@unique([source, externalId])
  @@index([source, eventType])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("webhook_events")
}

// ============================================================================
// APP SETTINGS — key/value store for runtime config
// ============================================================================

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}
// ============================================================================
// ENRICHMENT CACHE — shared TTL cache across all providers
// ============================================================================

model EnrichmentCache {
  id          Int      @id @default(autoincrement())
  provider    String
  cacheKey    String   @map("cache_key")
  data        Json
  costUsd     Decimal? @map("cost_usd") @db.Decimal(10, 6)
  fetchedAt   DateTime @default(now()) @map("fetched_at")
  expiresAt   DateTime @map("expires_at")

  @@unique([provider, cacheKey])
  @@index([provider, expiresAt])
  @@map("enrichment_cache")
}

// ============================================================================
// ENRICHMENT COST LOG — per-call cost tracking for all providers
// ============================================================================

model EnrichmentCostLog {
  id          Int      @id @default(autoincrement())
  provider    String
  operation   String
  clientId    Int?     @map("client_id")
  cacheHit    Boolean  @default(false) @map("cache_hit")
  costUsd     Decimal  @map("cost_usd") @db.Decimal(10, 6)
  latencyMs   Int?     @map("latency_ms")
  success     Boolean  @default(true)
  errorMsg    String?  @map("error_msg")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([provider, createdAt])
  @@index([clientId, createdAt])
  @@map("enrichment_cost_logs")
}


// ============================================================================
// RANK TRACKING — DataForSEO local SERP tracking
// ============================================================================

model KeywordTracker {
  id            Int       @id @default(autoincrement())
  clientId      Int       @map("client_id")
  keyword       String
  searchVolume  Int?      @map("search_volume")
  difficulty    Int?
  targetUrl     String?   @map("target_url")
  category      String?
  isActive      Boolean   @default(true) @map("is_active")
  addedAt       DateTime  @default(now()) @map("added_at")

  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  snapshots     RankSnapshot[]

  @@unique([clientId, keyword])
  @@index([clientId, isActive])
  @@map("keyword_trackers")
}

model RankSnapshot {
  id                  Int       @id @default(autoincrement())
  keywordId           Int       @map("keyword_id")
  clientId            Int       @map("client_id")
  scanDate            DateTime  @default(now()) @map("scan_date")
  organicPosition     Int?      @map("organic_position")
  localPackPosition   Int?      @map("local_pack_position")
  rankingUrl          String?   @map("ranking_url")
  localPackBusiness   String?   @map("local_pack_business")
  serpFeatures        Json?     @map("serp_features")
  zipCode             String    @map("zip_code")
  previousOrganic     Int?      @map("previous_organic")
  previousLocalPack   Int?      @map("previous_local_pack")

  keyword             KeywordTracker @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@index([keywordId, scanDate(sort: Desc)])
  @@index([clientId, scanDate(sort: Desc)])
  @@map("rank_snapshots")
}

// Tracks pending DataForSEO task IDs waiting for results
model PendingRankTask {
  id          Int       @id @default(autoincrement())
  taskId      String    @unique @map("task_id")   // DataForSEO task ID
  clientId    Int       @map("client_id")
  keywordId   Int       @map("keyword_id")
  zipCode     String    @map("zip_code")
  keyword     String
  postedAt    DateTime  @default(now()) @map("posted_at")
  resolvedAt  DateTime? @map("resolved_at")

  @@index([resolvedAt])
  @@index([postedAt])
  @@map("pending_rank_tasks")
}


// ============================================================================
// NAP CITATION SCRAPER — Directory consistency auditing
// ============================================================================

model CitationScan {
  id            Int       @id @default(autoincrement())
  clientId      Int       @map("client_id")
  scanDate      DateTime  @default(now()) @map("scan_date")
  totalChecked  Int       @map("total_checked")
  matches       Int
  mismatches    Int
  missing       Int
  errors        Int
  healthScore   Int       @map("health_score")
  results       Json                            // Per-directory detail array
  createdAt     DateTime  @default(now()) @map("created_at")

  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, scanDate(sort: Desc)])
  @@map("citation_scans")
}

model DirectoryHealth {
  id                  Int       @id @default(autoincrement())
  directoryKey        String    @unique @map("directory_key")
  displayName         String    @map("display_name")
  lastSuccess         DateTime? @map("last_success")
  lastFailure         DateTime? @map("last_failure")
  consecutiveFailures Int       @default(0) @map("consecutive_failures")
  isDegraded          Boolean   @default(false) @map("is_degraded")
  lastCheckedAt       DateTime? @map("last_checked_at")

  @@map("directory_health")
}

// ============================================================================
// GOOGLE ADS — OAuth credentials + connection
// ============================================================================

model GoogleAdsConnection {
  id              Int       @id @default(autoincrement())
  clientId        Int       @unique @map("client_id")

  // Encrypted OAuth tokens (AES-256-GCM)
  accessTokenEnc  String    @map("access_token_enc")
  refreshTokenEnc String    @map("refresh_token_enc")
  expiresAt       DateTime  @map("expires_at")

  // Google Ads resource identifiers
  customerId      String    @map("customer_id")   // 10-digit, e.g. "1234567890"
  accountName     String    @map("account_name")  // human-readable

  // Connection metadata
  googleEmail     String    @map("google_email")
  connectedAt     DateTime  @default(now()) @map("connected_at")
  lastSyncAt      DateTime? @map("last_sync_at")
  isActive        Boolean   @default(true) @map("is_active")

  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("google_ads_connections")
}

// GOOGLE BUSINESS PROFILE — OAuth credentials + connection
// ============================================================================

model GBPConnection {
  id              Int       @id @default(autoincrement())
  clientId        Int       @unique @map("client_id")
  
  // Encrypted OAuth tokens (AES-256-GCM)
  accessTokenEnc  String    @map("access_token_enc")   // encrypted
  refreshTokenEnc String    @map("refresh_token_enc")  // encrypted
  expiresAt       DateTime  @map("expires_at")
  
  // GBP resource identifiers
  accountId       String    @map("account_id")         // e.g. "accounts/123456"
  locationId      String    @map("location_id")        // e.g. "locations/987654321" (numeric, for Performance API)
  locationName    String    @map("location_name")      // human-readable name
  
  // Connection metadata
  googleEmail     String    @map("google_email")       // which Google account authorized
  connectedAt     DateTime  @default(now()) @map("connected_at")
  lastSyncAt      DateTime? @map("last_sync_at")
  isActive        Boolean   @default(true) @map("is_active")

  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("gbp_connections")
}

// ─── Document Vault ──────────────────────────────────────────────────────────

model VaultFile {
  id           Int       @id @default(autoincrement())
  name         String
  originalName String    @map("original_name")
  displayName  String?   @map("display_name")
  mimeType     String    @map("mime_type")
  size         Int
  blobUrl      String    @map("blob_url")
  space        VaultSpace
  category     String?
  uploadedBy   Int       @map("uploaded_by")
  uploader     User      @relation("VaultUploads", fields: [uploadedBy], references: [id])
  ownerId      Int?      @map("owner_id")
  owner        User?     @relation("VaultOwned", fields: [ownerId], references: [id])
  clientId     Int?      @map("client_id")
  client       ClientProfile? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  leadId       Int?      @map("lead_id")
  lead         Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  version      Int       @default(1)
  isLatest     Boolean   @default(true) @map("is_latest")
  supersededBy Int?      @map("superseded_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  @@index([space, category])
  @@index([uploadedBy])
  @@index([ownerId])
  @@index([clientId])
  @@index([leadId])
  @@map("vault_files")
}

enum VaultSpace {
  shared
  private
  client_reports
  signed_contracts
}

// ─── Prospect Audit + Demo History ───────────────────────────────────────────

model ProspectAudit {
  id          Int      @id @default(autoincrement())
  leadId      Int      @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  generatedBy Int      @map("generated_by")
  generator   User     @relation("AuditGenerator", fields: [generatedBy], references: [id])
  repName     String?  @map("rep_name")
  healthScore Int?     @map("health_score")
  gapCount    Int?     @map("gap_count")
  shareToken  String?  @unique @map("share_token")
  generatedAt DateTime @default(now()) @map("generated_at")

  @@index([leadId])
  @@map("prospect_audits")
}

model ProspectDemo {
  id          Int      @id @default(autoincrement())
  leadId      Int      @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  generatedBy Int      @map("generated_by")
  generator   User     @relation("DemoGenerator", fields: [generatedBy], references: [id])
  repName     String?  @map("rep_name")
  generatedAt DateTime @default(now()) @map("generated_at")

  @@index([leadId])
  @@map("prospect_demos")
}

// ============================================================================
// ADMIN TASK QUEUE
// ============================================================================

model AdminTask {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  category        String    @default("onboarding")
  // "onboarding" | "setup" | "billing" | "ops" | "followup" | "other"
  priority        String    @default("P2")
  // "P1" | "P2" | "P3" | "P4"
  status          String    @default("open")
  // "open" | "in_progress" | "done" | "cancelled"
  
  // Who owns it / who created it
  assignedToId    Int?      @map("assigned_to_id")
  createdById     Int?      @map("created_by_id")
  
  // Context link (optional — e.g. user this task is about)
  subjectUserId   Int?      @map("subject_user_id")
  // Could extend later: subjectClientId, subjectLeadId, etc.
  
  dueDate         DateTime? @map("due_date")
  completedAt     DateTime? @map("completed_at")
  notes           String?
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  assignedTo      User?     @relation("AdminTaskAssignee", fields: [assignedToId], references: [id])
  createdBy       User?     @relation("AdminTaskCreator", fields: [createdById], references: [id])
  
  @@index([status, priority])
  @@index([assignedToId, status])
  @@index([category])
  @@index([dueDate])
  @@map("admin_tasks")
}


// ============================================================================
// OPERATIONS LAYER — SPRINT 0 FOUNDATION
// ============================================================================

model AlertRule {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  sourceType      String    @map("source_type")   // "competitive_scan" | "payment" | "rank" | "nap" | "health"
  conditionType   String    @map("condition_type") // "threshold" | "delta" | "status_change" | "missing_data"
  conditionConfig Json      @map("condition_config") // { field, operator, value, window }
  severity        String    @default("warning")
  isActive        Boolean   @default(true) @map("is_active")
  autoCreateTask  Boolean   @default(false) @map("auto_create_task")
  taskTemplate    Json?     @map("task_template") // { title, category, priority, contentBrief }
  notifyOnTrigger Boolean   @default(true) @map("notify_on_trigger")
  cooldownMinutes Int       @default(1440) @map("cooldown_minutes") // 24h default
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  alerts          AlertEvent[]

  @@index([sourceType, isActive])
  @@map("alert_rules")
}

model AlertEvent {
  id              Int       @id @default(autoincrement())
  type            String    // "scan_alert" | "payment_overdue" | "rank_change" | "health_degraded" | "custom"
  severity        String    // "critical" | "warning" | "info"
  clientId        Int?      @map("client_id")
  title           String
  description     String?   @db.Text
  sourceType      String    @map("source_type")  // "competitive_scan" | "payment_check" | "rank_tracking" | "nap_scan" | "manual"
  sourceId        Int?      @map("source_id")    // FK to source record (scanId, invoiceId, etc.)
  metadata        Json?     // Structured alert data
  ruleId          Int?      @map("rule_id")
  acknowledged    Boolean   @default(false)
  acknowledgedBy  Int?      @map("acknowledged_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  autoTaskCreated Boolean   @default(false) @map("auto_task_created")
  createdAt       DateTime  @default(now()) @map("created_at")

  client          ClientProfile?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  rule            AlertRule?      @relation(fields: [ruleId], references: [id])
  acknowledger    User?           @relation("AlertAcknowledger", fields: [acknowledgedBy], references: [id])
  taskLinks       TaskAlertLink[]

  @@index([clientId, createdAt(sort: Desc)])
  @@index([type, severity])
  @@index([acknowledged])
  @@index([createdAt(sort: Desc)])
  @@map("alert_events")
}

model NotificationEvent {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  type        String    // "alert" | "task_assigned" | "task_status" | "report_ready" | "system"
  title       String
  body        String?
  href        String?   // Deep link to relevant page
  alertId     Int?      @map("alert_id")
  read        Boolean   @default(false)
  readAt      DateTime? @map("read_at")
  channel     String    @default("in_app") // "in_app" | "push" | "email" | "all"
  delivered   Boolean   @default(false)
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notification_events")
}

model TaskAlertLink {
  id        Int       @id @default(autoincrement())
  taskId    Int       @map("task_id")
  alertId   Int       @map("alert_id")
  createdAt DateTime  @default(now()) @map("created_at")

  task      ClientTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  alert     AlertEvent @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@unique([taskId, alertId])
  @@map("task_alert_links")
}

model DataSourceStatus {
  id                  Int       @id @default(autoincrement())
  provider            String    @unique
  // "dataforseo" | "ahrefs" | "pagespeed" | "google_business" | "google_ads" | "wave" | "outscraper"
  displayName         String    @map("display_name")
  status              String    @default("unknown")
  // "healthy" | "degraded" | "down" | "unknown"
  lastCheckAt         DateTime? @map("last_check_at")
  lastSuccessAt       DateTime? @map("last_success_at")
  lastFailureAt       DateTime? @map("last_failure_at")
  consecutiveFailures Int       @default(0) @map("consecutive_failures")
  avgLatencyMs        Int?      @map("avg_latency_ms")
  errorMessage        String?   @map("error_message")
  metadata            Json?     // Provider-specific health data
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("data_source_status")
}

model TaskChecklistItem {
  id          Int       @id @default(autoincrement())
  taskId      Int       @map("task_id")
  label       String
  isComplete  Boolean   @default(false) @map("is_complete")
  completedAt DateTime? @map("completed_at")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")

  task        ClientTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_checklist_items")
}

model TaskChecklistTemplate {
  id          Int      @id @default(autoincrement())
  name        String
  category    String?  // Matches ClientTask.category; null = universal
  description String?
  items       Json     // Array of { label, sortOrder }
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  recurringRules RecurringTaskRule[] @relation("RecurringTaskRuleTemplate")

  @@index([category, isActive])
  @@map("task_checklist_templates")
}

model RecurringTaskRule {
  id                  Int       @id @default(autoincrement())
  name                String
  clientId            Int?      @map("client_id") // null = applies to all active clients
  category            String    // ClientTask category
  title               String    // Template title (supports {clientName} interpolation)
  description         String?
  priority            String    @default("P3")
  checklistTemplateId Int?      @map("checklist_template_id")
  cronExpression      String    @map("cron_expression") // e.g. "0 9 1 * *" = 1st of month at 9am
  isActive            Boolean   @default(true) @map("is_active")
  lastRunAt           DateTime? @map("last_run_at")
  nextRunAt           DateTime? @map("next_run_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  tasks               ClientTask[]
  client              ClientProfile?         @relation("RecurringTaskRuleClient", fields: [clientId], references: [id], onDelete: SetNull)
  checklistTemplate   TaskChecklistTemplate? @relation("RecurringTaskRuleTemplate", fields: [checklistTemplateId], references: [id], onDelete: SetNull)

  @@index([isActive, nextRunAt])
  @@map("recurring_task_rules")
}

model SiteHealthSnapshot {
  id                   Int       @id @default(autoincrement())
  clientId             Int       @map("client_id")
  domainId             Int       @map("domain_id")
  performanceMobile    Int?      @map("performance_mobile")    // 0-100
  performanceDesktop   Int?      @map("performance_desktop")   // 0-100
  lcp                  Float?    // Largest Contentful Paint (ms)
  tbt                  Float?    // Total Blocking Time (ms) — replaces deprecated FID
  cls                  Float?    // Cumulative Layout Shift
  ttfb                 Float?    // Time to First Byte (ms) — from speed_index proxy; set if available
  fcp                  Float?    // First Contentful Paint (ms)
  seoScore             Int?      @map("seo_score")             // 0-100
  accessibilityScore   Int?      @map("accessibility_score")   // 0-100
  bestPracticesScore   Int?      @map("best_practices_score")  // 0-100
  previousMobile       Int?      @map("previous_mobile")       // For delta calculation
  previousDesktop      Int?      @map("previous_desktop")
  scanDate             DateTime  @default(now()) @map("scan_date")

  client               ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  domain               ClientDomain  @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([clientId, scanDate(sort: Desc)])
  @@index([domainId, scanDate(sort: Desc)])
  @@map("site_health_snapshots")
}

model GbpSnapshot {
  id                  Int       @id @default(autoincrement())
  clientId            Int       @map("client_id")

  // Aggregated insight totals for the period
  searchViews         Int?      @map("search_views")
  mapViews            Int?      @map("map_views")
  websiteClicks       Int?      @map("website_clicks")
  phoneClicks         Int?      @map("phone_clicks")
  directionClicks     Int?      @map("direction_clicks")

  // Review metrics
  reviewCount         Int?      @map("review_count")
  reviewAvg           Float?    @map("review_avg")
  newReviews          Int?      @map("new_reviews")

  // Content metrics
  photosCount         Int?      @map("photos_count")
  postsCount          Int?      @map("posts_count")

  // Deltas vs previous snapshot (for trend display)
  previousSearchViews Int?      @map("previous_search_views")
  previousMapViews    Int?      @map("previous_map_views")

  // Period the insight data covers
  periodStart         DateTime  @map("period_start")
  periodEnd           DateTime  @map("period_end")
  scanDate            DateTime  @default(now()) @map("scan_date")

  client              ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, scanDate(sort: Desc)])
  @@map("gbp_snapshots")
}

// ============================================================================
// SAVED SEARCHES — Sprint 7A
// ============================================================================

model SavedSearch {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String
  filtersJson Json     @map("filters_json")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_searches")
}

// ============================================================================
// DASHBOARD EVENTS — Sprint 18 / FEAT-019
// Lightweight platform usage tracking. No PII beyond userId.
// ============================================================================

model DashboardEvent {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  eventType  String   @map("event_type")   // "page_view" | "feature_use" | "action"
  page       String?                        // e.g. "/leads", "/clients/42"
  feature    String?                        // e.g. "enrich_lead", "generate_report", "bulk_approve"
  metadata   Json?                          // arbitrary key/value (no PII)
  sessionId  String?  @map("session_id")   // random per-tab UUID, not persisted to DB
  occurredAt DateTime @default(now()) @map("occurred_at")

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, occurredAt(sort: Desc)])
  @@index([eventType, occurredAt(sort: Desc)])
  @@index([feature, occurredAt(sort: Desc)])
  @@map("dashboard_events")
}

// ============================================================================
// PM IMPORT SESSIONS — FEAT-014
// Tracks one-time data migration sessions from external PM platforms.
// Stores scraped preview data server-side so the UI can paginate it
// without re-fetching from the source platform.
// ============================================================================

model PmImportSession {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  platform      String    // "basecamp" | "asana" | "clickup" | "monday" | "trello" | "csv"
  status        String    @default("connected") @map("status")
  // "connected" | "previewing" | "preview_ready" | "importing" | "complete" | "error"

  // Encrypted/stored credentials (cleared after import completes)
  credentialsJson Json?   @map("credentials_json") // { apiKey, accountId, accessToken, ... }

  // Preview payload — scraped data waiting for user review
  previewJson   Json?     @map("preview_json")    // { tasks[], contacts[], projects[] }
  previewStats  Json?     @map("preview_stats")   // { taskCount, contactCount, projectCount }

  // Commit results
  commitStats   Json?     @map("commit_stats")    // { tasksCreated, tasksSkipped, contactsCreated, errors[] }

  // Error capture
  errorMessage  String?   @map("error_message")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([platform, status])
  @@map("pm_import_sessions")
}
