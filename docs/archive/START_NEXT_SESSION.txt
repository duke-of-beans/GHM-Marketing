PAYMENTS SPRINT — COMPLETED February 22, 2026
============================================================

WHAT WAS BUILT THIS SESSION:

PAYMENTS-003 ✅ (schema first — blocks everything else)
  prisma/schema.prisma:
    - waveVendorId removed from User
    - contractorVendorId, contractorEntityName, contractorEmail added to User
    - WebhookEvent model added (source, eventType, externalId unique, rawPayload, status, error)
    - sourceEventId added to PaymentTransaction (idempotency key)
  src/lib/wave/sync.ts:
    - ensureWaveVendor updated: uses contractorVendorId, contractorEntityName, contractorEmail
  src/app/api/wave/partners/sync/route.ts — updated selects
  src/app/api/wave/partners/[userId]/route.ts — updated selects
  src/app/api/wave/partners/payout/route.ts — updated selects
  DB: `npx prisma db push` ran clean

PAYMENTS-001 ✅ Wave invoice.paid Webhook
  src/app/api/webhooks/wave/route.ts (NEW — 286 lines)
    - HMAC-SHA256 signature validation (timingSafeEqual)
    - WebhookEvent upsert for idempotency (dedup on source+externalId)
    - invoice.paid → finds ClientProfile by waveCustomerId
    - Runs generateClientMonthlyPayments() for that client
    - Creates pending PaymentTransaction records tagged with sourceEventId
    - Skips if transaction already exists for that client+user+type+month
    - Updates client lastPaymentDate + paymentStatus → 'current'
    - Returns 200 on processing failure (prevents Wave infinite retries)

PAYMENTS-002 ✅ Approval Flow
  src/app/api/payments/pending/route.ts (NEW — 111 lines)
    - GET pending transactions grouped by user+month
    - Returns summary: totalAmount, userCount, missingVendorCount
  src/app/api/payments/approve/route.ts (NEW — 151 lines)
    - POST: accepts transactionIds OR (clientId+month) OR (userId+month)
    - Marks approved, then best-effort Wave bill creation
    - Failed Wave bill does NOT block approval
    - Returns: approved count, waveCreated, waveFailed, missingVendorId names
  src/components/tasks/approvals-tab.tsx (UPDATED)
    - Added PaymentGroup type
    - Third section: "Payment Approvals" below tasks + content
    - Grouped by user with inline transaction breakdown
    - Amber warning when contractorVendorId not set
    - Single approve button per group: "Approve $X.XX"

PAYMENTS-006 ✅ Cron Schedule
  vercel.json: generate-payments moved 1 0 1 * * → 1 0 5 * *
  src/app/api/cron/generate-payments/route.ts: comment updated

BUILD: tsc --noEmit exit 0, no errors

============================================================
WHAT DAVID NEEDS TO DO BEFORE FIRST PAYMENT RUN:

1. Go to Wave → Contacts → Vendors → Create vendor for "Apex North"
   Copy the vendor ID from the URL or API

2. In the dashboard (or DB directly for now):
   Set User.contractorVendorId = <wave vendor id>
   Set User.contractorEntityName = "Apex North"
   Set User.contractorEmail = <billing email>

3. Register webhook in Wave dashboard:
   URL: https://ghm-dashboard.vercel.app/api/webhooks/wave
   Events: invoice.paid

4. Add to Vercel env vars:
   WAVE_WEBHOOK_SECRET = <secret from Wave webhook config>

WHAT'S NEXT (priority order):
- PAYMENTS-004: Position system (before first ops hire)
- PAYMENTS-005: Generalized employee onboarding wizard
- UI: Team settings → Contractor Info section (currently DB-only)
